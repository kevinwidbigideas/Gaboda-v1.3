<!DOCTYPE html>
<html lang="ko">

<head>
    {{ common_head|safe }}
    <title>로그인 / 회원가입 - TraVTI</title>
    <style>
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .animate-up {
            animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .tab-active {
            color: #2563eb;
            border-bottom: 2px solid #2563eb;
        }

        .tab-inactive {
            color: #64748b;
            border-bottom: 2px solid transparent;
        }

        .tab-inactive:hover {
            color: #334155;
        }
    </style>
</head>

<body class="bg-slate-50 min-h-screen flex flex-col">
    {{ header|safe }}

    <div class="flex-grow flex items-center justify-center p-4 relative overflow-hidden">
        <!-- Background Decor -->
        <div
            class="absolute top-[-20%] right-[-10%] w-[600px] h-[600px] bg-blue-200/30 rounded-full blur-[100px] animate-pulse">
        </div>
        <div class="absolute bottom-[-20%] left-[-10%] w-[600px] h-[600px] bg-purple-200/30 rounded-full blur-[100px] animate-pulse"
            style="animation-delay: 2s;"></div>

        <div
            class="w-full max-w-md bg-white rounded-3xl shadow-xl overflow-hidden glass-panel relative z-10 animate-up">
            <!-- Header Section -->
            <div class="p-8 text-center pb-0">
                <h1 class="text-3xl font-extrabold text-slate-900 mb-2">Welcome!</h1>
                <p class="text-slate-500 text-sm">TraVTI와 함께 여행을 시작하세요.</p>
            </div>

            <!-- Tabs -->
            <div class="flex border-b border-slate-100 mt-6 px-8">
                <button id="tab-login"
                    class="flex-1 py-4 text-center font-semibold transition-all tab-active">로그인</button>
                <button id="tab-signup"
                    class="flex-1 py-4 text-center font-semibold transition-all tab-inactive">회원가입</button>
            </div>

            <div class="p-8 pt-6">
                <!-- Social Login -->
                <div class="space-y-3 mb-6">
                    <button onclick="signInWithProvider('google')"
                        class="w-full bg-white border border-slate-200 hover:bg-slate-50 text-slate-700 font-medium py-3 px-4 rounded-xl flex items-center justify-center gap-3 transition-colors shadow-sm">
                        <img src="https://www.gstatic.com/images/branding/product/1x/googleg_32dp.png" class="w-5 h-5"
                            alt="Google">
                        Google로 계속하기
                    </button>
                    <button onclick="signInWithProvider('kakao')"
                        class="w-full bg-[#FEE500] hover:bg-[#FDD835] text-[#3C1E1E] font-medium py-3 px-4 rounded-xl flex items-center justify-center gap-3 transition-colors shadow-sm">
                        <svg viewBox="0 0 24 24" class="w-5 h-5 fill-current">
                            <path
                                d="M12 3C5.9 3 1 6.6 1 11c0 2.6 1.7 4.9 4.3 6.4-.3 1.1-1.1 4-1.2 4.6 0 .2.2.3.4.2 0 0 4.1-2.9 4.7-3.3.9.1 1.8.2 2.8.2 6.1 0 11-3.6 11-8s-4.9-8-11-8z" />
                        </svg>
                        Kakao로 계속하기
                    </button>
                </div>

                <div class="relative flex py-2 items-center">
                    <div class="flex-grow border-t border-slate-200"></div>
                    <span class="flex-shrink-0 mx-4 text-slate-400 text-xs font-medium">OR EMAIL</span>
                    <div class="flex-grow border-t border-slate-200"></div>
                </div>

                <!-- Email Form -->
                <form id="auth-form" class="mt-6 space-y-4" onsubmit="handleEmailAuth(event)">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">이메일</label>
                        <input type="email" id="email" required
                            class="w-full px-4 py-3 rounded-lg border-slate-200 focus:border-blue-500 focus:ring-blue-500 transition-colors bg-slate-50 focus:bg-white"
                            placeholder="name@example.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">비밀번호</label>
                        <input type="password" id="password" required
                            class="w-full px-4 py-3 rounded-lg border-slate-200 focus:border-blue-500 focus:ring-blue-500 transition-colors bg-slate-50 focus:bg-white"
                            placeholder="••••••••">
                    </div>

                    <div id="login-extra" class="flex items-center justify-between text-sm">
                        <label class="flex items-center text-slate-600">
                            <input type="checkbox"
                                class="rounded border-slate-300 text-blue-600 focus:ring-blue-500 mr-2">
                            로그인 유지
                        </label>
                        <a href="#" class="text-blue-600 hover:text-blue-700 font-medium">비밀번호 찾기</a>
                    </div>

                    <button type="submit" id="submit-btn"
                        class="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-4 rounded-xl shadow-lg shadow-slate-900/20 transition-all transform active:scale-95 mt-2">
                        로그인
                    </button>
                </form>

                <p id="auth-footer-text" class="mt-6 text-center text-sm text-slate-500">
                    계정이 없으신가요? <a href="#" onclick="toggleTab('signup')"
                        class="text-blue-600 hover:underline font-medium">회원가입</a>
                </p>
            </div>
        </div>
    </div>

    <script>
        (function () {
            const SUP_URL = "{{ supabase_url }}";
            const SUP_KEY = "{{ supabase_key }}";
            let sbClient = null;
            if (window.supabase) {
                sbClient = window.supabase.createClient(SUP_URL, SUP_KEY);
            }

            let currentMode = 'login'; // login | signup

            const tabLogin = document.getElementById('tab-login');
            const tabSignup = document.getElementById('tab-signup');
            const submitBtn = document.getElementById('submit-btn');
            const loginExtra = document.getElementById('login-extra');
            const headerTitle = document.querySelector('h1');
            const authFooterText = document.getElementById('auth-footer-text');

            window.toggleTab = function (mode) {
                currentMode = mode;
                if (mode === 'login') {
                    tabLogin.className = 'flex-1 py-4 text-center font-semibold transition-all tab-active';
                    tabSignup.className = 'flex-1 py-4 text-center font-semibold transition-all tab-inactive';
                    submitBtn.textContent = '로그인';
                    loginExtra.classList.remove('hidden');
                    headerTitle.textContent = 'Welcome!';

                    // Update footer link
                    if (authFooterText) {
                        authFooterText.innerHTML = `계정이 없으신가요? <a href="#" onclick="toggleTab('signup')" class="text-blue-600 hover:underline font-medium">회원가입</a>`;
                    }
                } else {
                    tabLogin.className = 'flex-1 py-4 text-center font-semibold transition-all tab-inactive';
                    tabSignup.className = 'flex-1 py-4 text-center font-semibold transition-all tab-active';
                    submitBtn.textContent = '회원가입';
                    loginExtra.classList.add('hidden');
                    headerTitle.textContent = 'Create Account';

                    // Update footer link
                    if (authFooterText) {
                        authFooterText.innerHTML = `이미 계정이 있으신가요? <a href="#" onclick="toggleTab('login')" class="text-blue-600 hover:underline font-medium">로그인</a>`;
                    }
                }
            }

            tabLogin.addEventListener('click', () => toggleTab('login'));
            tabSignup.addEventListener('click', () => toggleTab('signup'));

            // Handle URL Hash (e.g. #signup)
            if (window.location.hash === '#signup') toggleTab('signup');

            // Allow clicking the footer link to toggle
            // (Handled inline onclick for simplicity in replaced HTML)

            window.signInWithProvider = async function (provider) {
                if (!sbClient) return alert("System not loaded properly.");
                const { data, error } = await sbClient.auth.signInWithOAuth({
                    provider: provider,
                    options: {
                        redirectTo: window.location.origin
                    }
                });
                if (error) alert('Login Error: ' + error.message);
            };

            window.handleEmailAuth = async function (e) {
                e.preventDefault();
                if (!sbClient) return alert("System not loaded properly.");
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;

                submitBtn.disabled = true;
                submitBtn.textContent = '처리중...';

                if (currentMode === 'signup') {
                    const { data, error } = await sbClient.auth.signUp({
                        email: email,
                        password: password
                    });
                    if (error) {
                        alert('회원가입 실패: ' + error.message);
                        submitBtn.disabled = false;
                        submitBtn.textContent = '회원가입';
                    } else {
                        alert('가입 확인 이메일을 발송했습니다. 이메일을 확인해주세요!');
                        submitBtn.disabled = false;
                        submitBtn.textContent = '회원가입';
                    }
                } else {
                    const { data, error } = await sbClient.auth.signInWithPassword({
                        email: email,
                        password: password
                    });
                    if (error) {
                        alert('로그인 실패: ' + error.message);
                        submitBtn.disabled = false;
                        submitBtn.textContent = '로그인';
                    } else {
                        // Login successful, sync with backend
                        syncLogin(data.session);
                    }
                }
            }

            async function syncLogin(session) {
                try {
                    const resp = await fetch('/api/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            access_token: session.access_token,
                            refresh_token: session.refresh_token,
                            user: session.user
                        })
                    });
                    if (resp.ok) {
                        window.location.href = '/'; // Go to home
                    } else {
                        const errData = await resp.json();
                        alert('Login Sync Failed: ' + (errData.error || resp.status));
                        submitBtn.disabled = false;
                        submitBtn.textContent = '로그인';
                    }
                } catch (e) {
                    console.error('Login sync failed', e);
                    alert('서버 통신 오류');
                    submitBtn.disabled = false;
                    submitBtn.textContent = '로그인';
                }
            }

            // Handle OAuth Redirect & Auto-redirect if already logged in
            if (sbClient) {
                sbClient.auth.onAuthStateChange(async (event, session) => {
                    if (event === 'SIGNED_IN' && session) {
                        await syncLogin(session);
                    }
                });
            }
        })();
    </script>
</body>

</html>