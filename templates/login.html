<!DOCTYPE html>
<html lang="ko">

<head>
    {{ common_head|safe }}
    <title>로그인 / 회원가입 - TraVTI</title>
    <style>
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .animate-up {
            animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>
</head>

<body class="bg-slate-50 min-h-screen flex flex-col">
    {{ header|safe }}

    <div class="flex-grow flex items-center justify-center p-4 relative overflow-hidden">
        <!-- Background Decor -->
        <div
            class="absolute top-[-20%] right-[-10%] w-[600px] h-[600px] bg-blue-200/30 rounded-full blur-[100px] animate-pulse">
        </div>
        <div class="absolute bottom-[-20%] left-[-10%] w-[600px] h-[600px] bg-purple-200/30 rounded-full blur-[100px] animate-pulse"
            style="animation-delay: 2s;"></div>

        <div
            class="w-full max-w-md bg-white rounded-3xl shadow-xl overflow-hidden glass-panel relative z-10 animate-up p-8 px-10">

            <!-- Social View -->
            <div id="social-view">
                <div class="text-center pb-8 pt-4">
                    <h1 class="text-3xl font-extrabold text-slate-900 mb-3">Welcome!</h1>
                </div>

                <div class="space-y-3 mb-8">
                    <button onclick="signInWithProvider('kakao')"
                        class="w-full bg-white border border-slate-300 hover:bg-slate-50 text-slate-800 font-semibold py-3.5 px-4 rounded-xl flex items-center justify-center relative transition-colors shadow-sm">
                        <svg viewBox="0 0 24 24" class="absolute left-5 w-5 h-5 fill-[#3C1E1E]">
                            <path
                                d="M12 3C5.9 3 1 6.6 1 11c0 2.6 1.7 4.9 4.3 6.4-.3 1.1-1.1 4-1.2 4.6 0 .2.2.3.4.2 0 0 4.1-2.9 4.7-3.3.9.1 1.8.2 2.8.2 6.1 0 11-3.6 11-8s-4.9-8-11-8z" />
                        </svg>
                        카카오로 시작하기
                    </button>
                    <button onclick="signInWithProvider('google')"
                        class="w-full bg-white border border-slate-300 hover:bg-slate-50 text-slate-800 font-semibold py-3.5 px-4 rounded-xl flex items-center justify-center relative transition-colors shadow-sm">
                        <img src="https://www.gstatic.com/images/branding/product/1x/googleg_32dp.png" alt="Google"
                            class="absolute left-5 w-5 h-5">
                        구글로 시작하기
                    </button>
                </div>

            </div>


        </div>
    </div>

    <script>
        (function () {
            const SUP_URL = "{{ supabase_url }}";
            const SUP_KEY = "{{ supabase_key }}";
            let sbClient = null;
            if (window.supabase) {
                sbClient = window.supabase.createClient(SUP_URL, SUP_KEY);
            }

            window.signInWithProvider = async function (provider) {
                if (!sbClient) return alert("System not loaded properly.");

                const oauthOptions = {
                    redirectTo: window.location.origin
                };

                if (provider === 'kakao') {
                    oauthOptions.queryParams = {
                        scope: 'profile_nickname,profile_image'
                    };
                }

                const { data, error } = await sbClient.auth.signInWithOAuth({
                    provider: provider,
                    options: oauthOptions
                });
                if (error) alert('Login Error: ' + error.message);
            };

            async function syncLogin(session) {
                try {
                    const resp = await fetch('/api/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            access_token: session.access_token,
                            refresh_token: session.refresh_token,
                            user: session.user
                        })
                    });
                    if (resp.ok) {
                        window.location.href = '/'; // Go to home
                    } else {
                        const errData = await resp.json();
                        alert('Login Sync Failed: ' + (errData.error || resp.status));
                    }
                } catch (e) {
                    console.error('Login sync failed', e);
                    alert('서버 통신 오류');
                }
            }

            // Handle OAuth Redirect & Auto-redirect if already logged in
            if (sbClient) {
                sbClient.auth.onAuthStateChange(async (event, session) => {
                    if (event === 'SIGNED_IN' && session) {
                        await syncLogin(session);
                    }
                });
            }
        })();
    </script>
</body>

</html>