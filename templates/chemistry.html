<!DOCTYPE html>
<html lang="ko">

<head>
    {{ common_head|safe }}
    <title>새 그룹 만들기 - TraVTI</title>
</head>

<body class="bg-slate-50 min-h-screen flex flex-col">
    {{ header|safe }}

    <main class="flex-grow max-w-4xl mx-auto w-full px-6 py-12">
        <div class="mb-4">
            <button type="button" onclick="goBack()"
                class="inline-flex items-center gap-1 px-3 py-1.5 rounded-lg border border-slate-200 bg-white text-slate-600 text-sm font-bold hover:bg-slate-50 transition-colors">
                <span class="material-symbols-outlined text-base">arrow_back</span>
                이전 화면
            </button>
        </div>

        <div class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-slate-900 mb-2">새 그룹 만들기</h1>
            <p class="text-slate-500">여행 그룹의 이름을 정하고, 함께할 친구들을 초대해주세요.</p>
        </div>

        <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6 mb-8">
            <div class="flex flex-col gap-2">
                <label for="group-name-input" class="text-sm font-bold text-slate-800">그룹 이름 <span
                        class="text-red-500">*</span></label>
                <input type="text" id="group-name-input" placeholder="예) 부산 2박 3일 힐링 여행"
                    class="w-full px-4 py-3 border-2 border-slate-100 bg-slate-50 rounded-xl focus:outline-none focus:border-blue-500 focus:bg-white transition-colors text-slate-800 font-medium"
                    oninput="updateProceedButton()">
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- 왼쪽: 친구 목록 검색 및 추가 -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 flex flex-col h-[500px]">
                <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2 shrink-0">
                    <span class="material-symbols-outlined text-blue-500">search</span>
                    내 친구 초대
                </h3>

                <div class="relative mb-4 shrink-0">
                    <input type="text" id="stranger-search-input" placeholder="이름/이메일 검색"
                        class="w-full pl-10 pr-4 py-3 border-2 border-slate-100 bg-slate-50 rounded-xl focus:outline-none focus:border-blue-500 focus:bg-white transition-colors text-slate-800 text-sm font-medium">
                    <span
                        class="material-symbols-outlined text-xl absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">search</span>
                </div>

                <!-- 검색 결과 리스트 -->
                <div id="search-results" class="flex-grow flex flex-col gap-3 overflow-y-auto pr-2 pb-2">
                    <div class="flex items-center justify-center h-full text-sm text-slate-400">
                        불러오는 중...
                    </div>
                </div>
            </div>

            <!-- 오른쪽: 선택된 그룹 멤버 -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 flex flex-col h-[500px]">
                <div class="flex items-center justify-between mb-2 shrink-0">
                    <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                        <span class="material-symbols-outlined text-indigo-500">groups</span>
                        그룹 멤버
                    </h3>
                    <button id="clear-selected-friends" onclick="clearAllFriends()"
                        class="text-xs font-bold text-slate-500 hover:text-red-500 transition-colors">전체 해제</button>
                </div>
                <p id="selected-friend-summary" class="text-xs text-slate-500 mb-4 shrink-0">현재 1명(나 포함)</p>

                <div id="selected-friends-list" class="flex-grow space-y-2 overflow-y-auto pr-2 pb-2">
                    <div
                        class="text-sm text-slate-800 font-bold py-4 px-4 bg-slate-50 border border-slate-200 rounded-xl flex items-center gap-3">
                        <div
                            class="w-8 h-8 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center shrink-0">
                            <span class="material-symbols-outlined text-sm">person</span>
                        </div>
                        <div>
                            <div>{{ my_name }} (나)</div>
                            <div class="text-[11px] font-normal text-slate-500 mt-0.5">그룹장 · 결과 반영 완료</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex justify-end mt-4">
            <button id="go-report-btn" disabled onclick="createGroupAndGoToReport()"
                class="px-8 py-4 rounded-xl bg-slate-300 text-white text-base font-bold cursor-not-allowed transition-all shadow-sm">
                새 그룹 만들기
            </button>
        </div>

    </main>

    <footer class="bg-white border-t border-slate-200 mt-auto py-8">
        <div class="max-w-7xl mx-auto px-6 text-center text-slate-500 text-sm">
            &copy; 2026 Travis Inc. All rights reserved.
        </div>
    </footer>

    <script>
        const myName = "{{ my_name }}";
        const myLabel = "{{ my_label }}";
        const myMbti = "{{ my_mbti }}";
        const myId = "{{ my_id }}";

        let selectedFriends = [];
        let friendPoolData = [];
        let filteredFriendsData = [];

        function goBack() {
            if (window.history.length > 1) {
                window.history.back();
                return;
            }
            window.location.href = '/my-travti?tab=groups';
        }

        function updateProceedButton() {
            const button = document.getElementById('go-report-btn');
            const groupName = document.getElementById('group-name-input').value.trim();
            const hasFriends = selectedFriends.length > 0;
            const hasName = groupName.length > 0;

            if (hasFriends && hasName) {
                button.disabled = false;
                button.classList.remove('bg-slate-300', 'cursor-not-allowed');
                button.classList.add('bg-blue-600', 'hover:bg-blue-700', 'shadow-md');
                button.textContent = `총 ${selectedFriends.length + 1}명으로 그룹 생성하기`;
            } else {
                button.disabled = true;
                button.classList.add('bg-slate-300', 'cursor-not-allowed');
                button.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'shadow-md');

                if (!hasName) {
                    button.textContent = '그룹 이름을 입력해주세요';
                } else if (!hasFriends) {
                    button.textContent = '초대할 친구를 1명 이상 선택해주세요';
                }
            }
        }

        async function createGroupAndGoToReport() {
            const button = document.getElementById('go-report-btn');
            const groupName = document.getElementById('group-name-input').value.trim();

            if (!groupName) {
                alert('그룹 이름을 입력해주세요.');
                return;
            }
            if (!selectedFriends.length) {
                alert('초대할 친구를 1명 이상 선택해주세요.');
                return;
            }

            button.disabled = true;
            button.textContent = '생성 중...';

            const friendIds = selectedFriends.map(friend => friend.id).filter(Boolean);

            try {
                const response = await fetch('/api/groups/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        group_name: groupName,
                        member_ids: friendIds
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // 성공적으로 그룹 생성됨, 새로 생성된 그룹 리포트 페이지로 이동 (id 기반)
                    const groupId = data.group.id;
                    window.location.href = `/group-report?group_id=${groupId}`;
                } else {
                    alert('그룹 생성에 실패했습니다: ' + (data.message || data.error));
                    button.disabled = false;
                    updateProceedButton();
                }
            } catch (error) {
                console.error('Group creation error:', error);
                alert('서버 오류가 발생했습니다.');
                button.disabled = false;
                updateProceedButton();
            }
        }

        function renderSelectedFriends() {
            const listEl = document.getElementById('selected-friends-list');
            const summaryEl = document.getElementById('selected-friend-summary');
            const currentTotal = selectedFriends.length + 1;

            summaryEl.textContent = `현재 ${currentTotal}명 (나 포함)`;

            let html = `
                <div class="text-sm text-slate-800 font-bold py-4 px-4 bg-slate-50 border border-slate-200 rounded-xl flex items-center gap-3">
                    <div class="w-8 h-8 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center shrink-0">
                        <span class="material-symbols-outlined text-sm">person</span>
                    </div>
                    <div>
                        <div>${myName} (나)</div>
                        <div class="text-[11px] font-normal text-slate-500 mt-0.5">그룹장 · 결과 반영 완료</div>
                    </div>
                </div>
            `;

            if (selectedFriends.length > 0) {
                const friendRows = selectedFriends.map(friend => {
                    const mbtiText = friend.mbti || '미진단';
                    const labelText = friend.travti_label || '검사 결과 없음';
                    return `
                        <div class="flex items-center justify-between gap-2 px-4 py-3 rounded-xl border border-slate-200 bg-white shadow-sm">
                            <div class="flex items-center gap-3 min-w-0">
                                <div class="w-8 h-8 bg-slate-100 text-slate-400 rounded-full flex items-center justify-center shrink-0">
                                    <span class="material-symbols-outlined text-sm">person</span>
                                </div>
                                <div class="min-w-0">
                                    <div class="text-sm font-bold text-slate-800 truncate">${friend.name || '여행자'}</div>
                                    <div class="text-[11px] font-normal text-blue-500 mt-0.5 truncate">${labelText} · ${mbtiText}</div>
                                </div>
                            </div>
                            <button onclick="removeFriend('${friend.id}')" class="shrink-0 p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors">
                                <span class="material-symbols-outlined text-sm">close</span>
                            </button>
                        </div>
                    `;
                }).join('');
                html += friendRows;
            }

            listEl.innerHTML = html;
        }

        function selectFriend(user) {
            if (!user || !user.id) return;
            if (selectedFriends.some(friend => friend.id === user.id)) return;

            selectedFriends.push(user);
            renderSelectedFriends();
            renderSearchResults();
            updateProceedButton();
        }

        function removeFriend(friendId) {
            selectedFriends = selectedFriends.filter(friend => friend.id !== friendId);
            renderSelectedFriends();
            renderSearchResults();
            updateProceedButton();
        }

        function clearAllFriends() {
            selectedFriends = [];
            renderSelectedFriends();
            renderSearchResults();
            updateProceedButton();
        }

        function inviteFriendForTest(user) {
            if (!user) return;
            const inviteText = `${user.name || '친구'}님, 함께 여행 그룹을 만들기 위해 TraVTI 성향 검사를 부탁드려요!\n${window.location.origin}/test`;
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(inviteText)
                    .then(() => alert('초대 문구를 복사했습니다. 친구에게 보내면 이 목록에 결과가 표시됩니다!'))
                    .catch(() => alert(inviteText));
            } else {
                alert(inviteText);
            }
        }

        function renderSearchResults() {
            const resultsContainer = document.getElementById('search-results');

            if (!friendPoolData.length) {
                resultsContainer.innerHTML = `<div class="flex items-center justify-center h-full text-sm text-slate-400 text-center px-4 leading-relaxed">아직 등록된 친구가 없습니다.<br>마이페이지에서 친구를 먼저 추가해주세요.</div>`;
                return;
            }

            if (!filteredFriendsData.length) {
                resultsContainer.innerHTML = `<div class="flex items-center justify-center h-full text-sm text-slate-400">검색 결과가 없습니다.</div>`;
                return;
            }

            resultsContainer.innerHTML = filteredFriendsData.map((user) => {
                const isSelected = selectedFriends.some(friend => friend.id === user.id);
                const hasResult = !!user.travti_label;

                let actionButton = '';
                if (isSelected) {
                    actionButton = `<button disabled class="px-3 py-1.5 text-xs font-bold rounded-lg bg-slate-100 text-slate-400 cursor-not-allowed border border-slate-200">선택됨</button>`;
                } else if (!hasResult) {
                    actionButton = `<button onclick="inviteFriendForTest({name: '${user.name}', id: '${user.id}'})" class="px-3 py-1.5 text-xs font-bold rounded-lg bg-amber-100 text-amber-700 hover:bg-amber-200 transition-colors">검사 요청</button>`;
                } else {
                    actionButton = `<button onclick="selectFriend({id: '${user.id}', name: '${user.name}', email: '${user.email}', travti_label: '${user.travti_label}', mbti: '${user.mbti}'})" class="px-3 py-1.5 text-xs font-bold rounded-lg bg-blue-50 text-blue-600 hover:bg-blue-100 transition-colors border border-blue-200">초대</button>`;
                }

                const subLabel = hasResult
                    ? `<span class="text-[10px] font-bold text-slate-500 mt-0.5 truncate">${user.travti_label}</span>`
                    : `<span class="text-[10px] text-amber-500 mt-0.5">결과 없음</span>`;

                return `
                    <div class="flex items-center justify-between p-3 bg-white border border-slate-100 rounded-xl hover:bg-slate-50 transition-colors shrink-0 ${isSelected ? 'opacity-60' : ''}">
                        <div class="flex items-center gap-3 min-w-0">
                            <div class="w-10 h-10 ${hasResult ? 'bg-blue-50 text-blue-500' : 'bg-slate-100 text-slate-400'} rounded-full flex items-center justify-center shrink-0">
                                <span class="material-symbols-outlined text-lg">person</span>
                            </div>
                            <div class="flex flex-col min-w-0">
                                <span class="text-sm font-bold text-slate-800 truncate">${user.name}</span>
                                ${subLabel}
                            </div>
                        </div>
                        ${actionButton}
                    </div>
                `;
            }).join('');
        }

        async function searchUser() {
            const query = document.getElementById('stranger-search-input').value.trim().toLowerCase();
            if (!friendPoolData.length) return;

            filteredFriendsData = friendPoolData.filter(user => {
                if (!query) return true;
                return (user.name || '').toLowerCase().includes(query) || (user.email || '').toLowerCase().includes(query);
            });
            renderSearchResults();
        }

        document.getElementById('stranger-search-input').addEventListener('input', searchUser);

        async function loadDefaultGroupName() {
            try {
                const response = await fetch('/api/groups/list');
                const data = await response.json();
                const myGroups = (data.groups || []).filter(g => g.owner_id === myId);

                let baseName = `${myName}님의 친구그룹`;
                let defaultName = baseName;
                let maxNum = 1;
                let foundBase = false;

                myGroups.forEach(g => {
                    if (g.group_name === baseName) {
                        foundBase = true;
                    } else if (g.group_name && g.group_name.startsWith(baseName + ' ')) {
                        const numStr = g.group_name.replace(baseName + ' ', '');
                        const num = parseInt(numStr);
                        if (!isNaN(num) && num >= maxNum) {
                            maxNum = num;
                            foundBase = true;
                        }
                    }
                });

                if (foundBase) {
                    defaultName = `${baseName} ${maxNum + 1}`;
                }

                const inputEl = document.getElementById('group-name-input');
                if (inputEl.value === baseName || inputEl.value === "") {
                    inputEl.value = defaultName;
                    updateProceedButton();
                }
            } catch (e) {
                console.error(e);
            }
        }

        window.addEventListener('load', async () => {
            document.getElementById('group-name-input').value = `${myName}님의 친구그룹`;
            loadDefaultGroupName();

            const friendIdQuery = "{{ friend_id_query }}";
            const resultsContainer = document.getElementById('search-results');

            try {
                const response = await fetch('/api/friends/list');
                const data = await response.json();
                const rows = data.friends || [];
                friendPoolData = rows.map(row => ({
                    id: row.friend_id || row.id,
                    name: row.name || '여행자',
                    email: row.email || '',
                    travti_label: row.travti_label,
                    mbti: row.mbti,
                    vector_score: row.vector_score || {}
                })).filter(row => row.id && row.id !== myId);

                filteredFriendsData = [...friendPoolData];
                renderSearchResults();

                if (friendIdQuery && friendIdQuery !== "None") {
                    const friendToAdd = friendPoolData.find(f => f.id === friendIdQuery);
                    if (friendToAdd) {
                        selectFriend(friendToAdd);
                    } else {
                        // DB fetch if friend in query but not in friend list directly?
                    }
                }
            } catch (e) {
                console.error(e);
                resultsContainer.innerHTML = `<div class="flex items-center justify-center h-full text-sm text-red-500 text-center">친구 목록을 불러오지 못했습니다.</div>`;
            }

            renderSelectedFriends();
            updateProceedButton();
        });

    </script>
</body>

</html>