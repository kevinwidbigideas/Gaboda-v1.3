<!DOCTYPE html>
<html lang="ko">

<head>
    {{ common_head|safe }}
    <title>그룹 캐미 보기 - TraVTI</title>
</head>

<body class="bg-slate-50 min-h-screen flex flex-col">
    {{ header|safe }}

    <main class="flex-grow max-w-5xl mx-auto w-full px-6 py-12">
        <div class="mb-10 text-center">
            <h1 class="text-3xl font-bold text-slate-900 mb-2">여행 그룹 캐미 확인하기</h1>
            <p class="text-slate-500">나와 친구의 여행 스타일은 얼마나 잘 맞을까요? 친구를 검색하고 궁합을 확인해보세요.</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12">
            <!-- 나 (왼쪽) -->
            <div
                class="bg-white rounded-2xl shadow-sm border border-slate-200 p-8 flex flex-col items-center text-center">
                <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center text-blue-500 mb-4">
                    <span class="material-symbols-outlined text-4xl">person</span>
                </div>
                <h3 class="text-lg font-bold text-slate-800 mb-1">{{ my_name }}</h3>
                {% if my_label %}
                <span
                    class="px-3 py-1 bg-blue-50 text-blue-600 rounded-full text-sm font-bold border border-blue-100 mb-2">{{
                    my_label }}</span>
                <span class="text-xs text-slate-500 font-bold uppercase">{{ my_mbti }}</span>
                {% else %}
                <span class="text-sm text-slate-400">결과 없음</span>
                <a href="/test" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-bold">검사하러 가기</a>
                {% endif %}
            </div>

            <!-- VS / 궁합 (가운데) -->
            <div class="flex flex-col items-center justify-center relative">
                <div class="hidden lg:block absolute top-1/2 left-0 w-full h-0.5 bg-slate-200 -z-10 -translate-y-1/2">
                </div>

                <div id="chemistry-result-badge"
                    class="bg-white border-4 border-slate-100 rounded-full w-32 h-32 flex flex-col items-center justify-center shadow-lg z-10 transition-all">
                    <span class="material-symbols-outlined text-5xl text-slate-300 mb-1">help_center</span>
                    <span class="text-xs font-bold text-slate-500">친구 대기 중</span>
                </div>
            </div>

            <!-- 친구 (오른쪽) -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-8 flex flex-col items-center text-center relative overflow-hidden"
                id="friend-card">

                <!-- 친구가 선택되지 않았을 때 -->
                <div id="friend-empty-state"
                    class="w-full h-full flex flex-col items-center justify-center min-h-[160px]">
                    <div
                        class="w-16 h-16 bg-slate-50 border-2 border-dashed border-slate-300 rounded-full flex items-center justify-center text-slate-400 mb-4">
                        <span class="material-symbols-outlined text-2xl">person_add</span>
                    </div>
                    <p class="text-sm font-bold text-slate-500 mb-4">아래에서 친구를 검색해주세요</p>
                </div>

                <!-- 친구가 선택되었을 때 -->
                <div id="friend-selected-state" class="hidden w-full h-full flex flex-col items-center">
                    <button onclick="clearFriend()"
                        class="absolute top-4 right-4 text-slate-400 hover:text-red-500 transition-colors">
                        <span class="material-symbols-outlined text-xl">close</span>
                    </button>
                    <div
                        class="w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-500 mb-4">
                        <span class="material-symbols-outlined text-4xl">emoji_people</span>
                    </div>
                    <h3 class="text-lg font-bold text-slate-800 mb-1" id="selected-friend-name">친구 이름</h3>
                    <span id="selected-friend-label"
                        class="px-3 py-1 bg-indigo-50 text-indigo-600 rounded-full text-sm font-bold border border-indigo-100 mb-2">페르소나명</span>
                    <span id="selected-friend-mbti" class="text-xs text-slate-500 font-bold uppercase">MBTI</span>
                </div>
            </div>
        </div>

        <div id="chemistry-description-container"
            class="max-w-3xl mx-auto bg-indigo-50 border border-indigo-100 rounded-2xl p-8 mb-16 hidden text-center shadow-sm">
            <h3 class="text-xl font-bold text-indigo-900 mb-4 flex items-center justify-center gap-2">
                <span class="material-symbols-outlined text-indigo-500">auto_awesome</span>
                두 분의 여행 케미 포인트
            </h3>
            <p id="chemistry-description" class="text-indigo-800 leading-relaxed text-lg font-medium"></p>
        </div>


        <!-- 친구 검색 컨테이너 -->
        <div class="max-w-2xl mx-auto bg-white rounded-2xl shadow-sm border border-slate-200 p-8">
            <h3 class="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2">
                <span class="material-symbols-outlined text-blue-500">search</span>
                친구 검색하기
            </h3>

            <div class="relative mb-6">
                <input type="text" id="stranger-search-input" placeholder="친구의 이름이나 이메일을 검색해보세요."
                    class="w-full pl-12 pr-4 py-4 border-2 border-slate-100 bg-slate-50 rounded-xl focus:outline-none focus:border-blue-500 focus:bg-white transition-colors text-slate-800 font-medium">
                <span
                    class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-slate-400">search</span>
                <button onclick="searchUser()"
                    class="absolute right-2 top-1/2 -translate-y-1/2 bg-slate-900 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-slate-800 transition-colors">검색</button>
            </div>

            <!-- 검색 결과 리스트 -->
            <div id="search-results" class="flex flex-col gap-3 min-h-[100px] max-h-[300px] overflow-y-auto">
                <div class="flex items-center justify-center h-full text-sm text-slate-400 py-8">
                    검색 결과가 여기에 표시됩니다.
                </div>
            </div>
        </div>

    </main>

    <footer class="bg-white border-t border-slate-200 mt-auto py-8">
        <div class="max-w-7xl mx-auto px-6 text-center text-slate-500 text-sm">
            &copy; 2026 Travis Inc. All rights reserved.
        </div>
    </footer>

    <script>
        const myName = "{{ my_name }}";
        const myLabel = "{{ my_label }}";
        const myMbti = "{{ my_mbti }}";

        const myVectorStr = '{{ my_vector_score | safe }}';
        let myVector = {};
        try { myVector = JSON.parse(myVectorStr); } catch (e) { }

        let currentFriend = null;

        // MD파일 3.1.2 등급표 (9단계)
        function getTraitScore(d) {
            if (d < 0.1) return 18;
            if (d < 0.3) return 16;
            if (d < 0.5) return 14;
            if (d < 0.75) return 12;
            if (d < 0.95) return 10;
            if (d < 1.2) return 8;
            if (d < 1.4) return 6;
            if (d < 1.7) return 4;
            return 2;
        }

        // WHI 기반 100점 만점 케미 계산 (협의된 스케일링 로직 적용)
        function calculateChemistry(v1, v2) {
            if (!v1 || !v2 || Object.keys(v1).length === 0 || Object.keys(v2).length === 0) {
                return {
                    score: 50,
                    desc: "상세 검사 결과가 부족하여 정확한 분석이 어렵습니다.", color: "text-slate-500", icon: "help_center", title: "정보 부족"
                };
            }

            // 1. 성향 점수 추론(최대 65점)
            const eiDiff = Math.abs((v1.ei || 0) - (v2.ei || 0));
            const snDiff = Math.abs((v1.sn || 0) - (v2.sn || 0));
            const tfDiff = Math.abs((v1.tf || 0) - (v2.tf || 0));
            const jpDiff = Math.abs((v1.jp || 0) - (v2.jp || 0));

            // 각 성향별 최대 배점 가중치
            const eiScore = (getTraitScore(eiDiff) / 18) * 22.75;
            const snScore = (getTraitScore(snDiff) / 18) * 16.25;
            const tfScore = (getTraitScore(tfDiff) / 18) * 13.00;
            const jpScore = (getTraitScore(jpDiff) / 18) * 13.00;
            const traitTotal = eiScore + snScore + tfScore + jpScore;

            // 2. 체력 점수(최대 25점 ~최소 10점)
            const staminaDiff = Math.abs((v1.stamina || 0.5) - (v2.stamina || 0.5));
            let staminaTot = 25;
            if (staminaDiff > 0.6) staminaTot = 10;
            else if (staminaDiff > 0.4) staminaTot = 15;
            else if (staminaDiff > 0.15) staminaTot = 20;

            // 3. 음주 점수 (최대 10점 ~ 최소 2점)
            let alcTot = 10;
            const a1 = (v1.alcohol !== undefined) ? v1.alcohol : 0.5;
            const a2 = (v2.alcohol !== undefined) ? v2.alcohol : 0.5;

            if ((a1 > 0.8 && a2 > 0.8) || (a1 < 0.2 && a2 < 0.2)) {
                alcTot = 10;
            } else if (a1 > 0.2 && a1 < 0.8 && a2 > 0.2 && a2 < 0.8) {
                alcTot = 8;
            } else if ((a1 > 0.2 && a1 < 0.8 && a2 < 0.2) || (a2 > 0.2 && a2 < 0.8 && a1 < 0.2)) {
                alcTot = 6;
            } else if ((a1 > 0.8 && a2 > 0.2 && a2 < 0.8) || (a2 > 0.8 && a1 > 0.2 && a1 < 0.8)) {
                alcTot = 4;
            } else {
                alcTot = 2; // High Conflict
            }

            let totalScore = traitTotal + staminaTot + alcTot;
            return getChemistryDetails(Math.round(totalScore));
        }

        // 5점 단위 버킷팅으로 코멘트 노출
        function getChemistryDetails(score) {
            if (score >= 95) {
                return { score, icon: 'favorite', color: 'text-pink-500', title: '영혼의 단짝', desc: "모든 면에서 환상적으로 잘 맞습니다! 서로 말하지 않아도 통하는 완벽한 템포의 여행이 기대되네요." };
            } else if (score >= 90) {
                return { score, icon: 'handshake', color: 'text-pink-400', title: '찰떡궁합', desc: "여행 스타일의 우선순위가 대단히 비슷합니다. 사소한 차이점조차 부드럽게 넘어갈 수 있는 멋진 조합입니다." };
            } else if (score >= 85) {
                return { score, icon: 'thumb_up', color: 'text-indigo-500', title: '환상 케미', desc: "대부분의 상황에서 마음이 잘 맞습니다. 서로에게 신뢰감을 주며 안정적으로 계획을 실행할 수 있습니다." };
            } else if (score >= 80) {
                return { score, icon: 'high_quality', color: 'text-blue-500', title: '최고의 콤비', desc: "훌륭한 밸런스를 가진 파트너입니다. 대화로 가볍게 일정을 조율하며 즐겁게 다닐 수 있습니다." };
            } else if (score >= 75) {
                return { score, icon: 'diversity_3', color: 'text-blue-400', title: '티키타카', desc: "성향이 조금 다르지만 오히려 각자의 장점을 발휘할 수 있는 긍정적인 시너지 조합입니다." };
            } else if (score >= 70) {
                return { score, icon: 'balance', color: 'text-teal-500', title: '존중과 배려', desc: "뚜렷한 관점 차이가 존재할 수 있습니다. 상대를 이해하려는 배려 깊은 태도가 있다면 멋진 추억이 될 거예요." };
            } else if (score >= 65) {
                return { score, icon: 'directions_walk', color: 'text-teal-400', title: '맞춤형 동행', desc: "구체적인 타협안과 룰이 필요한 단계입니다. 일정 중 일부는 각자 자유시간을 쿨하게 보내는 것도 좋은 전략이에요." };
            } else if (score >= 60) {
                return { score, icon: 'compare_arrows', color: 'text-orange-400', title: '극과 극 콤비', desc: "서로 다른 별에서 왔다고 느낄 정도로 성향이 꽤 다르네요! 갈등을 방지하려면 미리 명확한 동선을 나눠보는 것을 권장합니다." };
            } else {
                return { score, icon: 'bolt', color: 'text-orange-500', title: '다이나믹 듀오', desc: "물과 기름! 관점의 차이가 크기 때문에 충돌을 방지하려면 저녁시간 등을 철저히 분리해서 행동하는 것도 좋은 방법 중 하나입니다." };
            }
        }

        function updateChemistryUI() {
            const badge = document.getElementById('chemistry-result-badge');
            const descContainer = document.getElementById('chemistry-description-container');
            const descEl = document.getElementById('chemistry-description');

            if (!currentFriend) {
                badge.innerHTML = `
                    <span class="material-symbols-outlined text-5xl text-slate-300 mb-1">help_center</span>
                    <span class="text-xs font-bold text-slate-500">친구 대기 중</span>
                `;
                badge.className = "bg-white border-4 border-slate-100 rounded-full w-32 h-32 flex flex-col items-center justify-center shadow-lg z-10 transition-all";
                descContainer.classList.add('hidden');
                return;
            }

            const chem = calculateChemistry(myVector, currentFriend.vector_score);

            badge.innerHTML = `
                <span class="material-symbols-outlined text-5xl ${chem.color} mb-1">${chem.icon}</span>
                <span class="text-sm font-black ${chem.color}">${chem.title}</span>
                <div class="absolute -top-2 -right-2 bg-slate-900 text-white text-[10px] font-bold px-2 py-1 rounded-full shadow border-2 border-white">${chem.score}점</div>
            `;
            // 테두리 색상 동적 변경
            badge.className = `bg-white border-4 border-${chem.color.split('-')[1]}-100 rounded-full w-32 h-32 flex flex-col items-center justify-center shadow-xl z-10 transition-all transform scale-110 relative`;

            descEl.innerText = chem.desc;
            descContainer.classList.remove('hidden');
        }

        function selectFriend(user) {
            currentFriend = user;

            // UI 변경
            document.getElementById('friend-empty-state').classList.add('hidden');
            const selectedState = document.getElementById('friend-selected-state');
            selectedState.classList.remove('hidden');

            document.getElementById('selected-friend-name').textContent = user.name;

            const labelEl = document.getElementById('selected-friend-label');
            if (user.travti_label) {
                labelEl.textContent = user.travti_label;
                labelEl.classList.remove('hidden');
            } else {
                labelEl.classList.add('hidden');
            }

            const mbtiEl = document.getElementById('selected-friend-mbti');
            if (user.mbti) {
                mbtiEl.textContent = user.mbti;
                mbtiEl.classList.remove('hidden');
            } else {
                mbtiEl.textContent = '아직 검사하지 않음';
                mbtiEl.classList.remove('hidden');
            }

            // 스크롤 올리기 (궁합 결과 보이도록)
            window.scrollTo({ top: 0, behavior: 'smooth' });

            updateChemistryUI();
        }

        function clearFriend() {
            currentFriend = null;
            document.getElementById('friend-selected-state').classList.add('hidden');
            document.getElementById('friend-empty-state').classList.remove('hidden');
            updateChemistryUI();
        }

        let searchResultsData = [];

        async function searchUser() {
            const query = document.getElementById('stranger-search-input').value.trim();
            const resultsContainer = document.getElementById('search-results');

            if (!query) {
                resultsContainer.innerHTML = `<div class="flex items-center justify-center h-full text-sm text-slate-400 py-8">검색어를 입력해주세요.</div>`;
                return;
            }

            resultsContainer.innerHTML = `<div class="flex items-center justify-center h-full py-8"><span class="material-symbols-outlined animate-spin text-blue-500">sync</span></div>`;

            try {
                const response = await fetch('/api/search_user?q=' + encodeURIComponent(query));
                const data = await response.json();

                if (!data.results || data.results.length === 0) {
                    resultsContainer.innerHTML = `<div class="flex items-center justify-center h-full text-sm text-slate-500 py-8 text-center px-4 bg-slate-50 rounded-xl">"${query}"에 해당하는 사용자를 찾을 수 없습니다.</div>`;
                    return;
                }

                const myUserId = "{{ my_id }}";

                // 필터링: 나 자신 제외
                searchResultsData = data.results.filter(u => u.id !== myUserId);

                if (searchResultsData.length === 0) {
                    resultsContainer.innerHTML = `<div class="flex items-center justify-center h-full text-sm text-slate-500 py-8">검색 결과가 없습니다.</div>`;
                    return;
                }

                resultsContainer.innerHTML = searchResultsData.map((user, index) => {
                    return `
                                    <div class="flex items-center justify-between p-4 bg-white border border-slate-200 rounded-xl shadow-sm hover:border-blue-300 transition-colors">
                                        <div class="flex items-center gap-4">
                                            <div class="w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center text-slate-400 shrink-0">
                                                <span class="material-symbols-outlined">person</span>
                                            </div>
                                            <div class="flex flex-col">
                                                <span class="font-bold text-slate-800">${user.name}</span>
                                                <span class="text-xs text-slate-400">${user.email || ''}</span>
                                                ${user.travti_label ?
                            `<span class="text-[10px] font-bold text-blue-500 mt-0.5">${user.travti_label} (${user.mbti})</span>` :
                            `<span class="text-[10px] text-slate-400 mt-0.5">결과 없음</span>`
                        }
                                            </div>
                                        </div>
                                        <button onclick="selectFriend(searchResultsData[${index}])" class="px-4 py-2 bg-slate-900 text-white text-xs font-bold rounded-lg hover:bg-slate-700 transition">선택</button>
                                    </div>
                                    `;
                }).join('');

            } catch (e) {
                console.error(e);
                resultsContainer.innerHTML = `<div class="flex items-center justify-center h-full text-sm text-red-500 py-8">검색 중 오류가 발생했습니다.</div>`;
            }
        }

        // 엔터 키로 검색 가능하게
        document.getElementById('stranger-search-input').addEventListener('keypress',
            function (e) {
                if (e.key === 'Enter') searchUser();
            });

        // 페이지 로드 시 friend_id 쿼리 파라미터가 있다면 자동 검색 및 적용 로직
        window.addEventListener('load', async () => {
            const friendIdQuery = "{{ friend_id_query }}";
            if (friendIdQuery && friendIdQuery !== "None") {
                try {
                    const response = await fetch('/api/get_user_identity?user_id=' + friendIdQuery);
                    const data = await response.json();
                    if (data && data.name) {
                        selectFriend({
                            id: friendIdQuery,
                            name: data.name,
                            travti_label: data.travti_label,
                            mbti: data.mbti,
                            vector_score: data.vector_score
                        });
                    }
                } catch (e) { }
            }
        });

    </script>
</body>

</html>